#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Check if any component files are staged (UI, shared, or feature components)
STAGED_COMPONENTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E "^src/(components/(ui|shared)|features/.*/components)/.*\.tsx$" || true)

if [ -n "$STAGED_COMPONENTS" ]; then
  echo "üîç Checking components for forwardRef usage (100% compliance required)..."
  
  node scripts/check-forward-ref.js
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå forwardRef check failed. Please update components to use React.forwardRef."
    echo "   All components must support ref forwarding for Radix UI compatibility."
    echo ""
    exit 1
  fi
  
  echo "‚úÖ forwardRef checks passed (100% compliance)"
else
  echo "‚è≠Ô∏è  No component files modified, skipping forwardRef checks"
fi

# Check if English locale file is staged (reference file)
STAGED_EN_LOCALE=$(git diff --cached --name-only --diff-filter=ACM | grep "^public/locales/en/ui\.json$" || true)

if [ -n "$STAGED_EN_LOCALE" ]; then
  echo "üåê English locale modified ‚Äî syncing ALL 16 languages..."
  
  # Run with --fix to auto-add missing keys as placeholders to ALL languages
  node scripts/check-language.js --fix
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Translation sync failed. Please fix the issues above before committing."
    echo ""
    exit 1
  fi
  
  # Re-stage ALL locale files (not just modified ones)
  echo "üìù Staging all synced locale files..."
  git add public/locales/
  
  echo "‚úÖ All 16 languages synchronized"
else
  # Check if any non-English locale files are staged (detect manual edits)
  STAGED_OTHER_LOCALES=$(git diff --cached --name-only --diff-filter=ACM | grep "^public/locales/.*\.json$" | grep -v "^public/locales/en/" || true)
  
  if [ -n "$STAGED_OTHER_LOCALES" ]; then
    echo "üîç Non-English locale files modified ‚Äî running validation..."
    
    # Just validate, don't auto-fix (manual edits should be intentional)
    node scripts/check-language.js
    
    if [ $? -ne 0 ]; then
      echo ""
      echo "‚ùå Translation check failed. Run 'node scripts/check-language.js --fix' to sync."
      echo ""
      exit 1
    fi
    
    echo "‚úÖ Translation validation passed"
  else
    echo "‚è≠Ô∏è  No locale files modified, skipping translation checks"
  fi
fi