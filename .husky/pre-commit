#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ============================================================
# SECURITY CHECKS (run on migrations and source files)
# ============================================================

STAGED_MIGRATIONS=$(git diff --cached --name-only --diff-filter=ACM | grep "^supabase/migrations/.*\.sql$" || true)
STAGED_SRC=$(git diff --cached --name-only --diff-filter=ACM | grep "^src/.*\.\(ts\|tsx\)$" || true)

if [ -n "$STAGED_MIGRATIONS" ] || [ -n "$STAGED_SRC" ]; then
  echo "üîí Running security checks..."
  
  node scripts/check-security.js
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Security check failed. Please fix the issues above before committing."
    echo "   See docs/SECURITY.md for security guidelines."
    echo ""
    exit 1
  fi
  
  echo "‚úÖ Security checks passed"
else
  echo "‚è≠Ô∏è  No migrations or source files modified, skipping security checks"
fi

# ============================================================
# FORWARDREF COMPLIANCE (100% required for Radix compatibility)
# ============================================================

STAGED_COMPONENTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E "^src/(components/(ui|shared)|features/.*/components)/.*\.tsx$" || true)

if [ -n "$STAGED_COMPONENTS" ]; then
  echo "üîç Checking components for forwardRef usage (100% compliance required)..."
  
  node scripts/check-forward-ref.js
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå forwardRef check failed. Please update components to use React.forwardRef."
    echo "   All components must support ref forwarding for Radix UI compatibility."
    echo ""
    exit 1
  fi
  
  echo "‚úÖ forwardRef checks passed (100% compliance)"
else
  echo "‚è≠Ô∏è  No component files modified, skipping forwardRef checks"
fi

# ============================================================
# TRANSLATION SYNC (16 languages, auto-sync from English)
# ============================================================

STAGED_EN_LOCALE=$(git diff --cached --name-only --diff-filter=ACM | grep "^public/locales/en/ui\.json$" || true)

if [ -n "$STAGED_EN_LOCALE" ]; then
  echo "üåê English locale modified ‚Äî syncing ALL 16 languages..."
  
  node scripts/check-language.js --fix
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Translation sync failed. Please fix the issues above before committing."
    echo ""
    exit 1
  fi
  
  git add public/locales/
  
  echo "‚úÖ All 16 languages synchronized"
else
  STAGED_OTHER_LOCALES=$(git diff --cached --name-only --diff-filter=ACM | grep "^public/locales/.*\.json$" | grep -v "^public/locales/en/" || true)
  
  if [ -n "$STAGED_OTHER_LOCALES" ]; then
    echo "üîç Non-English locale files modified ‚Äî running validation..."
    
    node scripts/check-language.js
    
    if [ $? -ne 0 ]; then
      echo ""
      echo "‚ùå Translation check failed. Run 'node scripts/check-language.js --fix' to sync."
      echo ""
      exit 1
    fi
    
    echo "‚úÖ Translation validation passed"
  else
    echo "‚è≠Ô∏è  No locale files modified, skipping translation checks"
  fi
fi