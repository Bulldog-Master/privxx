#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Check if any component files are staged (UI, shared, or feature components)
STAGED_COMPONENTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E "^src/(components/(ui|shared)|features/.*/components)/.*\.tsx$" || true)

if [ -n "$STAGED_COMPONENTS" ]; then
  echo "üîç Checking components for forwardRef usage (100% compliance required)..."
  
  node scripts/check-forward-ref.js
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå forwardRef check failed. Please update components to use React.forwardRef."
    echo "   All components must support ref forwarding for Radix UI compatibility."
    echo ""
    exit 1
  fi
  
  echo "‚úÖ forwardRef checks passed (100% compliance)"
else
  echo "‚è≠Ô∏è  No component files modified, skipping forwardRef checks"
fi

# Check if any locale files are staged
STAGED_LOCALES=$(git diff --cached --name-only --diff-filter=ACM | grep "^public/locales/.*\.json$" || true)

if [ -n "$STAGED_LOCALES" ]; then
  echo "üîç Running translation checks on modified locale files..."
  
  # Run with --fix to auto-add missing keys as placeholders
  node scripts/check-language.js --fix
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Translation check failed. Please fix the issues above before committing."
    echo ""
    exit 1
  fi
  
  # Re-stage any auto-fixed locale files
  if [ -n "$(git diff --name-only public/locales/)" ]; then
    echo "üìù Auto-fixed locale files detected, staging changes..."
    git add public/locales/
  fi
  
  echo "‚úÖ Translation checks passed"
else
  echo "‚è≠Ô∏è  No locale files modified, skipping translation checks"
fi